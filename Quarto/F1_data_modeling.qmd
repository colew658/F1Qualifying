---
title: "F1 Project Data Modeling"
author: "Cole Wagner"
format:
  html:
    toc: true
    self-contained: true
    code-fold: true
    code-line-numbers: true
    code-tools: true
    cache: true
    theme: "yeti"
editor: visual
---

```{r setup}
library(tidyverse)
library(tidymodels)
library(janitor)
set.seed(1)

full_no_missing <- read_csv("../Data/full_no_missing.csv")

full_clean_types <- full_no_missing %>%
  # Automatic conversion
  type_convert() %>%
  # Convert some numeric variables to factors
  mutate(
    MEETING_KEY = as.factor(MEETING_KEY),
    SESSION_KEY = as.factor(SESSION_KEY),
    DRIVER_NUMBER = as.factor(DRIVER_NUMBER),
    RAINFALL = as.factor(RAINFALL)
  )
```

# Engineering the Outcome

The outcome variable is the difference between the actual lap time and the average lap time (given the track).

```{r OutcomeEngineer}
# Find the average lap time for each track
avg_time_summary <- full_clean_types %>%
  group_by(CIRCUIT_SHORT_NAME) %>%
  summarise(
    AVG_LAP_DURATION = mean(LAP_DURATION)
  ) %>%
  ungroup()

# Create the outcome TIME_DIFF
modeling_data <- left_join(full_clean_types, avg_time_summary) %>%
  mutate(TIME_DIFF = LAP_DURATION - AVG_LAP_DURATION) %>%
  # Keep only the variables needed for modeling
  select(c(13:19, 23, 33:34, 36))
  
```

# Base Model Pipeline

```{r basemodel}
# Create train/test split
f1_split <- initial_split(modeling_data, strata = "TIME_DIFF")
f1_train <- training(f1_split)
f1_test <- testing(f1_split)


base_rec <- recipe(TIME_DIFF ~ ., data = f1_train) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_dummy(all_nominal_predictors(), one_hot = F)

#Choose repeated 10-fold CV
kfold_rep <- vfold_cv(f1_train, v = 10, repeats = 5, strata = "TIME_DIFF")

# Create linear regression model framework
f1_lm <- linear_reg() %>% 
  set_engine("lm") %>%
  set_mode("regression")

# Build the modeling workflow
lm_workflow <- workflow() %>%
  add_model(f1_lm) %>%
  add_recipe(base_rec)

# Fit the model according to different loss functions and see the results
lm_workflow %>% 
  last_fit(f1_split, metrics = metric_set(rmse, mae)) %>% 
  collect_metrics()

# Resampled error rate
fit_resamples(
  lm_workflow,
  resamples = kfold_rep,
  metrics = metric_set(rmse, mae)
) %>%
  collect_metrics()

# Extract coefficients
lm_coefs <- lm_workflow %>%
  fit(f1_train) %>%
  extract_fit_parsnip() %>%
  tidy()


```







